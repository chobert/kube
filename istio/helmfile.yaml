repositories:
  - name: incubator
    url: https://charts.helm.sh/incubator
  - name: istio
    url: https://istio-release.storage.googleapis.com/charts

releases:
  - name: istio-base
    namespace: istio-system
    chart: istio/base
    version: 1.12.9
    createNamespace: true

  - name: istiod
    namespace: istio-system
    chart: istio/istiod
    version: 1.12.9
    needs:
      - istio-system/istio-base

  - name: istio-ingress
    namespace: istio-system
    chart: istio/gateway
    version: 1.12.9
    needs:
      - istio-system/istio-base
      - istio-system/istiod
    values:
      - service:
          loadBalancerIP: 78.47.232.231
          ports:
            - port: 15021
              targetPort: 15021
              name: status-port
              protocol: TCP
            - port: 80
              targetPort: 80
              name: http2
              protocol: TCP
            - port: 443
              targetPort: 443
              name: https
              protocol: TCP
            - port: 2222
              targetPort: 2222
              name: gitlab-ssh
              protocol: TCP

  - name: istio-default-gateway
    chart: incubator/raw
    namespace: istio-system
    needs:
      - istio-ingress
    values:
      - resources:
          - apiVersion: cert-manager.io/v1
            kind: Certificate
            metadata:
              name: root-certificate
              namespace: istio-system
            spec:
              issuerRef:
                name: letsencrypt
                kind: ClusterIssuer
              secretName: root-cert-secret
              commonName: chobert.fr
              dnsNames:
                - chobert.fr

          - apiVersion: networking.istio.io/v1alpha3
            kind: Gateway
            metadata:
              name: root-gateway
              namespace: istio-system
            spec:
              selector:
                istio: ingressgateway
              servers:
                - port:
                    number: 443
                    name: https
                    protocol: HTTPS
                  tls:
                    mode: SIMPLE
                    credentialName: root-cert-secret
                  hosts:
                    - chobert.fr
                - port:
                    number: 80
                    name: http
                    protocol: HTTP
                  tls:
                    httpsRedirect: true # sends 301 redirect for http requests
                  hosts:
                    - chobert.fr
